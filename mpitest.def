Bootstrap: docker
From: ubuntu:22.04

%files
  src /opt

%post
  apt-get update
  apt-get -y install build-essential git curl tar zip unzip wget pkg-config m4 python3

  # Install MPI
  MPI_VERSION=3.1.4
  cd /usr/local
  wget https://download.open-mpi.org/release/open-mpi/v3.1/openmpi-$MPI_VERSION.tar.bz2
  tar -jxpf openmpi-$MPI_VERSION.tar.bz2
  rm openmpi-$MPI_VERSION.tar.bz2 # remove compressed file
  cd openmpi-$MPI_VERSION
  ./configure --prefix=/usr/local/openmpi
  make -j$(nproc) all
  make install
  cd ..
  rm -rf openmpi-$MPI_VERSION # remove source

  # Compile the MPI application
  cd /opt
  /usr/local/openmpi/bin/mpicc /opt/src/mpitest.c -o /opt/mpitest

%environment
  export CMAKE_MAKE_PROGRAM=/usr/bin/make
  export CMAKE_C_COMPILER=/usr/local/openmpi/bin/mpicc
  export CMAKE_CXX_COMPILER=/usr/local/openmpi/bin/mpi++
  export PMIX_MCA_pcompress_base_silence_warning=1
  export OMPI_DIR=/usr/local/openmpi
  export SINGULARITY_OMPI_DIR=$OMPI_DIR
  export SINGULARITYENV_APPEND_PATH=$OMPI_DIR/bin
  export SINGULARITYENV_APPEND_LD_LIBRARY_PATH=$OMPI_DIR/lib